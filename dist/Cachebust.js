/* https://github.com/kpander/cachebust */
/* dist/Cachebust.js v1.1.6 Thu Sep 07 2023 10:27:37 GMT-0400 (Eastern Daylight Saving Time) */

const fs=require("fs"),path=require("path"),Filerefs=require("@kpander/filerefs-js");module.exports=class a{static get KEY(){return"ts"}static get TAGS(){return{link:"href",script:"src",img:"src",source:"srcset",audio:"src",video:"src",track:"src"}}static css(r,e={}){if("string"!=typeof r)return!1;let s={...e};s.path=s.path||"",s.key=s.key||a.KEY;return[...r.matchAll(/@import\s+["']((?!http)([^"']+\.css)([\?#].*)?)["'];/g)].forEach(e=>{var t=e[0],e=e[1],e=a._cachebust_href(e,s);r=r.replaceAll(t,`@import "${e}";`)}),r}static html(i,c={}){if("string"!=typeof i)return!1;c.path=c.path||"",c.key=c.key||a.KEY,c.tags=c.tags||a.TAGS,c.basePath=c.path;const l=Filerefs.getFilerefs(i,c);return Object.keys(l).forEach(e=>{var t=l[e],r=a._get_timestamp(t.relativeBase,c);let s;(t.absolute?((s=new URL("http://test.com"+t.absolute)).search=t.relativeParams,s):s=new URL("http://test.com"+t.relative)).searchParams.set(c.key,r);r=t.pre+t.relativeBase+s.search+t.relativeHash+t.post;i=i.replaceAll(e,r)}),i}static _cachebust_href(e,t){var r=new URL(e,"https://fakeurl.url");let s=r.pathname;"."===e[0]&&"."!==s[0]&&(s=a._prefix_relatives(e,s));var i=a._get_timestamp(s,t);r.searchParams.set(t.key,i);let c=r.toString().replace("https://fakeurl.url/","");return"/"===e[0]&&"/"!==c[0]&&(c="/"+c),c="."===e[0]&&"."!==c[0]?a._prefix_relatives(e,c):c}static _prefix_relatives(e,t){var r=[],s=e.split("/");for(let e=0;e<s.length;e++){var a=s[e];if("."!==a[0])break;r.push(a)}return r.join("/")+"/"+t}static _get_timestamp(e,t){e=path.join(t.path,e);return fs.existsSync(e)&&""!==t.path?""+fs.statSync(e).mtime.valueOf():Date.now()+"-m"}};